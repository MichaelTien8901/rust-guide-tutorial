# CI workflow to build and test all Rust code examples
# Note: Many examples have intentional unused code for educational purposes,
# so we don't treat warnings as errors

name: Build Examples

on:
  push:
    branches: [main, master]
    paths:
      - 'examples/**'
      - '.github/workflows/examples.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'examples/**'
      - '.github/workflows/examples.yml'
  # Allow manual trigger
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build all examples
  build:
    name: Build Examples
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "examples -> target"
          cache-all-crates: "true"

      - name: Build all examples
        run: |
          echo "========================================"
          echo "Building all Rust examples"
          echo "========================================"
          echo ""

          PASSED=0
          FAILED=0
          FAILED_LIST=""

          for cargo_file in $(find examples -name "Cargo.toml" | sort); do
            dir=$(dirname "$cargo_file")
            echo -n "Building $dir... "

            if cargo build --release --manifest-path "$cargo_file" 2>/tmp/build_err.log; then
              echo "OK"
              PASSED=$((PASSED + 1))
            else
              echo "FAILED"
              cat /tmp/build_err.log
              FAILED=$((FAILED + 1))
              FAILED_LIST="$FAILED_LIST $dir"
            fi
          done

          echo ""
          echo "========================================"
          echo "Build Summary"
          echo "========================================"
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"

          if [ -n "$FAILED_LIST" ]; then
            echo ""
            echo "Failed examples:$FAILED_LIST"
            exit 1
          fi

          echo ""
          echo "All examples built successfully!"

  # Run tests for examples that have them
  test:
    name: Test Examples
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "examples -> target"
          cache-all-crates: "true"

      - name: Test all examples
        run: |
          echo "========================================"
          echo "Testing all Rust examples"
          echo "========================================"
          echo ""

          PASSED=0
          FAILED=0

          for cargo_file in $(find examples -name "Cargo.toml" | sort); do
            dir=$(dirname "$cargo_file")
            echo -n "Testing $dir... "

            if cargo test --manifest-path "$cargo_file" 2>/tmp/test_err.log; then
              echo "OK"
              PASSED=$((PASSED + 1))
            else
              echo "FAILED"
              cat /tmp/test_err.log
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "========================================"
          echo "Test Summary: $PASSED passed, $FAILED failed"
          echo "========================================"

          if [ $FAILED -gt 0 ]; then
            exit 1
          fi

  # Optional: Check formatting (informational only)
  fmt-check:
    name: Format Check (Advisory)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: |
          echo "Checking code formatting (advisory only)..."
          UNFORMATTED=""

          for cargo_file in $(find examples -name "Cargo.toml" | sort); do
            dir=$(dirname "$cargo_file")
            if ! cargo fmt --manifest-path "$cargo_file" --check 2>/dev/null; then
              UNFORMATTED="$UNFORMATTED $dir"
            fi
          done

          if [ -n "$UNFORMATTED" ]; then
            echo ""
            echo "Examples needing formatting:$UNFORMATTED"
            echo ""
            echo "Run 'cargo fmt' in each directory to fix."
          else
            echo "All examples are properly formatted!"
          fi
